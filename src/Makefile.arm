VERSION := v2.7.4

SBAT_GENERATION := 1

# TODO - split out x86/x64 objects from aarch64.
#OBJECTS := prefix.o startup.o callback.o main.o vsprintf.o string.o peloader.o
#OBJECTS += int13.o vdisk.o cpio.o stdio.o lznt1.o xca.o die.o efi.o efimain.o
#OBJECTS += efiguid.o efifile.o efipath.o efiboot.o efiblock.o cmdline.o
#OBJECTS += wimpatch.o huffman.o lzx.o wim.o wimfile.o pause.o sha1.o cookie.o
#OBJECTS += paging.o memmap.o

OBJECTS := vsprintf.o string.o peloader.o
OBJECTS += vdisk.o cpio.o stdio.o lznt1.o xca.o die.o efi.o efimain.o
OBJECTS += efiguid.o efifile.o efipath.o efiboot.o efiblock.o cmdline.o
OBJECTS += wimpatch.o huffman.o lzx.o wim.o wimfile.o pause.o sha1.o cookie.o

OBJECTS_i386 := $(patsubst %.o,%.i386.o,$(OBJECTS))
OBJECTS_x86_64 := $(patsubst %.o,%.x86_64.o,$(OBJECTS))
OBJECTS_i386_x86_64 := $(patsubst %.o,%.i386.x86_64.o,$(OBJECTS))
OBJECTS_aarch64 := $(patsubst %.o,%.aarch64.o,$(OBJECTS))

HEADERS := $(wildcard *.h)

# TODO - this is only needed for Windows builds, to be removed.
CC := C:\gcc-arm-10.3-2021.07-mingw-w64-i686-aarch64-none-elf\bin\aarch64-none-elf-gcc.exe
AS := C:\gcc-arm-10.3-2021.07-mingw-w64-i686-aarch64-none-elf\aarch64-none-elf\bin\as.exe
AR := C:\gcc-arm-10.3-2021.07-mingw-w64-i686-aarch64-none-elf\aarch64-none-elf\bin\ar.exe
OBJCOPY := C:\gcc-arm-10.3-2021.07-mingw-w64-i686-aarch64-none-elf\aarch64-none-elf\bin\objcopy.exe
RANLIB := C:\gcc-arm-10.3-2021.07-mingw-w64-i686-aarch64-none-elf\aarch64-none-elf\bin\ranlib.exe
LD := C:\gcc-arm-10.3-2021.07-mingw-w64-i686-aarch64-none-elf\aarch64-none-elf\bin\ld.exe
CP := copy
RM := del /f
#CP		:= cp
#RM		:= rm -f
#OBJCOPY 	:= objcopy

HOST_CC		:= $(CC)
AS		:= $(AS)
ECHO		:= echo
AR		:= $(AR)
RANLIB		:= $(RANLIB)

GCAB		:= gcab
PESIGN		:= pesign
DIFF		:= diff
CUT		:= cut
BINUTILS_DIR	:= /usr
BFD_DIR		:= $(BINUTILS_DIR)
ZLIB_DIR	:= /usr

HOST_CFLAGS += -Wall -W -Werror

# TODO - turn on warning as error and update sources to build with newer GCC compiler (stricter warnings).
#CFLAGS += -Os -ffreestanding -Wall -W -Werror -nostdinc -I. -fshort-wchar
CFLAGS += -Os -ffreestanding -Wall -W -nostdinc -I. -fshort-wchar
CFLAGS += -DVERSION="\"$(VERSION)\""
CFLAGS += -DSBAT_GENERATION="\"$(SBAT_GENERATION)\""

CFLAGS_i386 += -m32 -march=i386 -malign-double -fno-pic
CFLAGS_x86_64 += -m64 -mno-red-zone -fpie
CFLAGS_aarch64 += 

# Enable stack protection if available
#
SPG_TEST = $(CC) -fstack-protector-strong -mstack-protector-guard=global \
		 -x c -c /dev/null -o /dev/null >/dev/null 2>&1
SPG_FLAGS := $(shell $(SPG_TEST) && $(ECHO) '-fstack-protector-strong ' \
					    '-mstack-protector-guard=global')
CFLAGS += $(SPG_FLAGS)

# Inhibit unwanted debugging information
CFI_TEST = $(CC) -fno-dwarf2-cfi-asm -fno-exceptions -fno-unwind-tables \
		 -fno-asynchronous-unwind-tables -x c -c /dev/null \
		 -o /dev/null >/dev/null 2>&1
CFI_FLAGS := $(shell $(CFI_TEST) && \
	       $(ECHO) '-fno-dwarf2-cfi-asm -fno-exceptions ' \
		    '-fno-unwind-tables -fno-asynchronous-unwind-tables')
WORKAROUND_CFLAGS += $(CFI_FLAGS)

# Add -maccumulate-outgoing-args if required by this version of gcc
MS_ABI_TEST_CODE := extern void __attribute__ (( ms_abi )) ms_abi(); \
		    void sysv_abi ( void ) { ms_abi(); }
MS_ABI_TEST = $(ECHO) '$(MS_ABI_TEST_CODE)' | \
	      $(CC) -m64 -mno-accumulate-outgoing-args -x c -c - -o /dev/null \
		    >/dev/null 2>&1
MS_ABI_FLAGS := $(shell $(MS_ABI_TEST) || $(ECHO) '-maccumulate-outgoing-args')
WORKAROUND_CFLAGS += $(MS_ABI_FLAGS)

# Inhibit warnings from taking address of packed struct members
WNAPM_TEST = $(CC) -Wno-address-of-packed-member -x c -c /dev/null \
		   -o /dev/null >/dev/null 2>&1
WNAPM_FLAGS := $(shell $(WNAPM_TEST) && \
		 $(ECHO) '-Wno-address-of-packed-member')
WORKAROUND_CFLAGS += $(WNAPM_FLAGS)

# Inhibit LTO
LTO_TEST = $(CC) -fno-lto -x c -c /dev/null -o /dev/null >/dev/null 2>&1
LTO_FLAGS := $(shell $(LTO_TEST) && $(ECHO) '-fno-lto')
WORKAROUND_CFLAGS += $(LTO_FLAGS)

CFLAGS += $(WORKAROUND_CFLAGS)
CFLAGS += $(EXTRA_CFLAGS)

ifneq ($(DEBUG),)
CFLAGS += -DDEBUG=$(DEBUG)
endif

CFLAGS += -include compiler.h

###############################################################################
#
# Final targets

all : wimboot wimboot.i386 wimboot.x86_64 wimboot.cab

# TODO - merge x86/x64 and aarch64 build rules.
#wimboot : wimboot.x86_64 Makefile
wimboot : wimboot.aarch64 Makefile
	$(CP) $< $@
	$(CP) $@ ..\$@

wimboot.%.elf : lib.%.a script-aarch64.lds Makefile
	$(LD) -m aarch64elf -T script-aarch64.lds -o $@ -q -Map wimboot.$*.map \
		lib.$*.a
	$(CP) wimboot.aarch64.elf wimboot.elf

wimboot.%.unsigned : wimboot.%.elf  Makefile
	$(OBJCOPY) -Obinary $< $@
	./util/elf2efi64 --subsystem=10 wimboot.elf wimboot.efi

wimboot.%.unsigned.hash : wimboot.%.unsigned Makefile
#	$(PESIGN) -h -i $< | $(CUT) -d" " -f2- > $@
	$(CP) $< $@

wimboot.%.efi : wimboot.%.unsigned Makefile
	$(CP) $< $@

wimboot.%.efi.hash : wimboot.%.efi Makefile
#	$(PESIGN) -h -i $< | $(CUT) -d" " -f2- > $@
	$(CP) $< $@

wimboot.% : wimboot.%.efi wimboot.%.efi.hash wimboot.%.unsigned.hash Makefile
	$(DIFF) wimboot.$*.efi.hash wimboot.$*.unsigned.hash
	$(CP) $< $@

wimboot.cab : wimboot.i386.efi wimboot.x86_64.efi Makefile
	$(GCAB) -n -c $@ wimboot.i386.efi wimboot.x86_64.efi

###############################################################################
#
# i386 objects

%.i386.s : %.S $(HEADERS) Makefile
	$(CC) $(CFLAGS) $(CFLAGS_i386) -DASSEMBLY -Ui386 -E $< -o $@

%.i386.s : %.c $(HEADERS) Makefile
	$(CC) $(CFLAGS) $(CFLAGS_i386) -S $< -o $@

%.i386.o : %.i386.s i386.i Makefile
	$(AS) --32 i386.i $< -o $@

lib.i386.a : $(OBJECTS_i386) Makefile
	$(RM) $@
	$(AR) r $@ $(OBJECTS_i386)
	$(RANLIB) $@

###############################################################################
#
# i386 objects to be linked into an x86_64 binary

%.i386.x86_64.raw.o : %.i386.s i386.i Makefile
	$(AS) --64 i386.i $< -o $@

%.i386.x86_64.o : %.i386.x86_64.raw.o Makefile
	$(OBJCOPY) --prefix-symbols=__i386_ $< $@

###############################################################################
#
# x86_64 objects

%.x86_64.s : %.S $(HEADERS) Makefile
	$(CC) $(CFLAGS) $(CFLAGS_x86_64) -DASSEMBLY -Ui386 -E $< -o $@

%.x86_64.s : %.c $(HEADERS) Makefile
	$(CC) $(CFLAGS) $(CFLAGS_x86_64) -S $< -o $@

%.x86_64.o : %.x86_64.s x86_64.i Makefile
	$(AS) --64 x86_64.i $< -o $@

lib.x86_64.a : $(OBJECTS_x86_64) $(OBJECTS_i386_x86_64) Makefile
	$(RM) $@
	$(AR) r $@ $(OBJECTS_x86_64) $(OBJECTS_i386_x86_64)
	$(RANLIB) $@

###############################################################################
#
# aarch64 objects

%.aarch64.s : %.S $(HEADERS) Makefile
	$(CC) $(CFLAGS) $(CFLAGS_aarch64) -DASSEMBLY -Ui386 -E $< -o $@

%.aarch64.s : %.c $(HEADERS) Makefile
	$(CC) $(CFLAGS) $(CFLAGS_aarch64) -S $< -o $@

%.aarch64.o : %.aarch64.s aarch64.i Makefile
	$(AS) --64 aarch64.i $< -o $@

lib.aarch64.a : $(OBJECTS_aarch64) Makefile
	$(RM) $@
	$(AR) r $@ $(OBJECTS_aarch64)
	$(RANLIB) $@

###############################################################################
#
# EFI relocator

EFIRELOC_CFLAGS := -I$(BINUTILS_DIR)/include -I$(BFD_DIR)/include \
		   -I$(ZLIB_DIR)/include -idirafter .
EFIRELOC_LDFLAGS := -L$(BINUTILS_DIR)/lib -L$(BFD_DIR)/lib -L$(ZLIB_DIR)/lib \
		    -lbfd -ldl -liberty -lz -Wl,--no-warn-search-mismatch

efireloc : efireloc.c Makefile
	$(CC) $(HOST_CFLAGS) $(EFIRELOC_CFLAGS) $< $(EFIRELOC_LDFLAGS) -o $@

###############################################################################
#
# Cleanup

clean :
	$(RM) *.o *.a *.elf *.map
	$(RM) efireloc
	$(RM) wimboot wimboot.i386 wimboot.x86_64 wimboot.aarch64 ..\wimboot
	$(RM) wimboot.i386.unsigned wimboot.x86_64.unsigned wimboot.aarch64.unsigned
	$(RM) wimboot.i386.efi wimboot.x86_64.efi wimboot.aarch64 wimboot.cab
